<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Calculateur Lag GIPG – Version A</title>
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <style>
    :root{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
    body{margin:0;padding:16px;max-width:820px;margin-inline:auto;}
    h1{font-size:20px;margin:8px 0 16px 0;}
    .card{border:1px solid #ddd;border-radius:14px;padding:14px;margin:12px 0;}
    .row{display:grid;grid-template-columns:1fr 170px;gap:10px;align-items:center;margin:10px 0;}
    label{font-size:14px;color:#111;}
    input,select{font-size:16px;padding:10px;border:1px solid #ccc;border-radius:12px;width:100%;box-sizing:border-box;}
    .small{font-size:12px;color:#555;margin-top:6px;line-height:1.35;}
    .results{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px;}
    .kpi{border:1px solid #eee;border-radius:14px;padding:12px;}
    .kpi .v{font-size:26px;font-weight:700;margin-top:6px;}
    .kpi .u{font-size:12px;color:#666;}
    details summary{cursor:pointer;font-weight:600;}
    table{width:100%;border-collapse:collapse;margin-top:10px;}
    th,td{border-bottom:1px solid #eee;padding:8px;font-size:14px;}
    td input{padding:8px;border-radius:10px;}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;}
    button{font-size:16px;padding:10px 12px;border-radius:12px;border:1px solid #ccc;background:#f7f7f7;}
    button.primary{background:#111;color:#fff;border-color:#111;}
    hr{border:none;border-top:1px solid #eee;margin:14px 0;}
  </style>
</head>
<body>
  <h1>Calculateur Lag GIPG – Version A (complet)</h1>

  <div class="card">
    <div class="row">
      <label for="profile">Calibre / profil</label>
      <select id="profile"></select>
    </div>

    <div class="row">
      <label for="c4">Distance cible LOS (m) — Excel C4</label>
      <input id="c4" inputmode="decimal" placeholder="ex: 155" />
    </div>
    <div class="row">
      <label for="c5">Angle de tir (°) — Excel C5</label>
      <input id="c5" inputmode="decimal" placeholder="ex: 65" />
    </div>
    <div class="row">
      <label for="c6">Vitesse embarcation (km/h) — Excel C6</label>
      <input id="c6" inputmode="decimal" placeholder="ex: 30" />
    </div>

    <div class="results">
      <div class="kpi">
        <div>Lag immobile (Excel C22)</div>
        <div class="v" id="outC22">—</div>
        <div class="u">mrad (1 décimale)</div>
      </div>

      <div class="kpi">
        <div>Correction vent (Excel C24)</div>
        <div class="v" id="outC24">—</div>
        <div class="u">cm (1 décimale)</div>
      </div>

      <div class="kpi">
        <div>Lead parallèle (Excel C25)</div>
        <div class="v" id="outC25">—</div>
        <div class="u">mrad (1 décimale)</div>
      </div>

      <div class="kpi">
        <div>Angle visée brut (Excel C10)</div>
        <div class="v" id="outC10">—</div>
        <div class="u">mrad (1 décimale)</div>
      </div>
    </div>

    <div class="small">
      ✅ Correspondance exacte si distance exacte.<br>
      ✅ Sinon interpolation linéaire (logique type MATCH(...,1) + interpolation).
    </div>
  </div>

  <div class="card">
    <h2 style="font-size:16px;margin:0 0 8px 0;">Calculateur LOS (hypoténuse)</h2>
    <div class="row">
      <label for="c27">Distance parallèle (m) — Excel C27</label>
      <input id="c27" inputmode="decimal" placeholder="ex: 100" />
    </div>
    <div class="row">
      <label for="c28">Angle de tir (°) — Excel C28</label>
      <input id="c28" inputmode="decimal" placeholder="ex: 45" />
    </div>
    <div class="results">
      <div class="kpi">
        <div>Distance LOS (Excel C29)</div>
        <div class="v" id="outC29">—</div>
        <div class="u">m (1 décimale)</div>
      </div>
    </div>
  </div>

  <div class="card">
    <details>
      <summary>⚙️ Tables TOF & Vent (éditables par profil)</summary>

      <div class="row">
        <label for="profileName">Nom du profil</label>
        <input id="profileName" />
      </div>

      <hr/>

      <h3 style="font-size:14px;margin:0;">Table TOF (s)</h3>
      <div class="small">Remplis les TOF pour chaque distance (10m, puis 100m, 200m…1500m).</div>
      <div id="tofWrap"></div>

      <hr/>

      <h3 style="font-size:14px;margin:0;">Table Vent (cm) par 1 m/s</h3>
      <div class="small">Remplis les valeurs en cm/1m/s pour chaque distance (mêmes distances).</div>
      <div id="ventWrap"></div>

      <div class="actions">
        <button class="primary" id="saveProfile">Sauvegarder sur cet iPhone</button>
        <button id="exportJson">Exporter profils (.json)</button>
        <button id="importJson">Importer profils (.json)</button>
        <input id="importFile" type="file" accept="application/json" style="display:none;" />
      </div>
    </details>
  </div>

<script>
/* =========================
   Paramètres distances
   ========================= */
function defaultDistances(){
  const arr = [10];
  for (let d=100; d<=1500; d+=100) arr.push(d);
  return arr;
}

/* =========================
   Stockage
   ========================= */
const STORAGE_KEY = "lag_gipg_versionA_full_v1";

function makeBlankTable(distances){
  return distances.map(d => [d, null]); // [distance, value]
}

function defaultData(){
  const distances = defaultDistances();
  const profiles = Array.from({length:5}, (_,i)=>({
    name: `Calibre ${i+1}`,
    tof_table: makeBlankTable(distances),
    vent_table: makeBlankTable(distances),
  }));
  return { selected: 0, profiles };
}

function loadData(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if (raw) { try { return JSON.parse(raw); } catch {} }
  return defaultData();
}
function saveData(data){ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }

/* =========================
   Helpers
   ========================= */
function toNum(v){
  const s = String(v ?? "").trim().replace(",", ".");
  if (!s) return NaN;
  const n = Number(s);
  return Number.isFinite(n) ? n : NaN;
}
function rad(deg){ return deg * Math.PI / 180; }
function fmt1(v){
  if (!Number.isFinite(v)) return "—";
  const n = Math.round(v*10)/10;
  return n.toFixed(1);
}

/* Excel-like interpolation:
   - si distance exacte: valeur exacte
   - sinon interpolation entre les deux points entourant x
   - bornes: min/max
*/
function interpExcel(x, table){
  if (!Number.isFinite(x) || !Array.isArray(table) || table.length < 2) return NaN;
